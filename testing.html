<!DOCTYPE html>
<html>
<head>
  <title>Indore Address Search + PIN Code + Style Switcher</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 90vh; }
    #searchBox {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    #suggestions {
      background: white;
      position: absolute;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
    }
    #suggestions div {
      padding: 8px;
      cursor: pointer;
    }
    #suggestions div:hover {
      background: #eee;
    }
  </style>
</head>
<body>

<input type="text" id="searchBox" placeholder="Search address or 6-digit PIN code in India..." />
<div id="suggestions"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const jawgKey = ""; // <-- Put your Jawg API key here

  // --- Tile Layers ---
  const voyager = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }
  );

  const jawgStreets = L.tileLayer(
    `https://tile.jawg.io/jawg-streets/{z}/{x}/{y}{r}.png?access-token=${jawgKey}`, {
      attribution: '<a href="https://www.jawg.io">© Jawg</a> © <a href="https://www.openstreetmap.org/">OSM</a>',
      subdomains: 'abcd',
      maxZoom: 22
    }
  );

  // Create map
  const map = L.map('map', {
    center: [22.7196, 75.8577], // Indore
    zoom: 13,
    layers: [voyager] // default
  });

  // Style switcher
  const baseMaps = {
    "Carto Voyager": voyager,
    "Jawg Streets": jawgStreets
  };
  L.control.layers(baseMaps).addTo(map);

  // Search logic
  let marker;
  const searchBox = document.getElementById("searchBox");
  const suggestions = document.getElementById("suggestions");

  searchBox.addEventListener("input", async () => {
    const query = searchBox.value.trim();
    if (query.length < 2) {
      suggestions.innerHTML = "";
      return;
    }

    // If 6-digit PIN code → India Post API
    if (/^\d{6}$/.test(query)) {
      const res = await fetch(`https://api.postalpincode.in/pincode/${query}`);
      const data = await res.json();
      suggestions.innerHTML = "";

      if (!data[0] || data[0].Status !== "Success") {
        const noResult = document.createElement("div");
        noResult.textContent = "No PIN code found";
        suggestions.appendChild(noResult);
        return;
      }

      data[0].PostOffice.forEach(po => {
        const display = `${po.Name}, ${po.District}, ${po.State}, ${po.Pincode}`;
        const item = document.createElement("div");
        item.textContent = display;
        item.onclick = async () => {
          const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=in&limit=1&q=${po.Pincode}`);
          const geoData = await geoRes.json();
          if (geoData.length) {
            const lat = parseFloat(geoData[0].lat);
            const lon = parseFloat(geoData[0].lon);
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map).bindPopup(display).openPopup();
            map.setView([lat, lon], 12);
          }
          searchBox.value = display;
          suggestions.innerHTML = "";
        };
        suggestions.appendChild(item);
      });
      return;
    }

    // Otherwise → Nominatim address search
    const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=in&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`;
    const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();

    suggestions.innerHTML = "";
    if (!data.length) {
      const noResult = document.createElement("div");
      noResult.textContent = "No results found";
      suggestions.appendChild(noResult);
      return;
    }

    data.forEach(place => {
      const display = place.display_name;
      const item = document.createElement("div");
      item.textContent = display;
      item.onclick = () => {
        const lat = parseFloat(place.lat);
        const lon = parseFloat(place.lon);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map).bindPopup(display).openPopup();
        map.setView([lat, lon], 15);
        suggestions.innerHTML = "";
        searchBox.value = display;
      };
      suggestions.appendChild(item);
    });
  });

  // Reverse geocoding on map click
  map.on("click", async (e) => {
    const { lat, lng } = e.latlng;
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
    const data = await res.json();
    const address = data.display_name || "Unknown location";
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map).bindPopup(address).openPopup();
    searchBox.value = address;
  });
</script>

</body>
</html>
